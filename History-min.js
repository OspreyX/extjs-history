Ext.define("xui.History",function(){var e={};var t={};e.Adapter={bind:function(e,n,r){Ext.EventManager.on(e,n,r);var i=t[e.id]=t[e.id]||{};i[n]=i[n]||[];i[n].push(r)},trigger:function(n,r,i){if(r=="statechange"){xui.History.fireEvent("statechange",e.getState());return}var s=t[n.id],o=[i||{}],u,a,f;if(s&&(u=s[r])){for(a=0,f=u.length;a<f;a++){u[a].apply(n,o)}}},extractEventData:function(e,t){return t&&t.browserEvent&&t.browserEvent[e]||undefined},onDomLoad:function(e){Ext.onReady(e)}};e.initHtml4=function(){e.enabled=true;e.savedHashes=[];e.isLastHash=function(t){var n=e.getHashByIndex(),r;r=t===n;return r};e.saveHash=function(t){if(e.isLastHash(t)){return false}e.savedHashes.push(t);return true};e.getHashByIndex=function(t){var n=null;if(typeof t==="undefined"){n=e.savedHashes[e.savedHashes.length-1]}else if(t<0){n=e.savedHashes[e.savedHashes.length+t]}else{n=e.savedHashes[t]}return n};e.discardedHashes={};e.discardedStates={};e.discardState=function(t,n,r){var i=e.getHashByState(t),s;s={discardedState:t,backState:r,forwardState:n};e.discardedStates[i]=s;return true};e.discardHash=function(t,n,r){var i={discardedHash:t,backState:r,forwardState:n};e.discardedHashes[t]=i;return true};e.discardedState=function(t){var n=e.getHashByState(t),r;r=e.discardedStates[n]||false;return r};e.discardedHash=function(t){var n=e.discardedHashes[t]||false;return n};e.recycleState=function(t){var n=e.getHashByState(t);if(e.discardedState(t)){delete e.discardedStates[n]}return true};if(e.emulated.hashChange){e.hashChangeInit=function(){e.checkerFunction=null;var t="",n,r,i,s;if(e.isInternetExplorer()){n="historyjs-iframe";r=document.createElement("iframe");r.setAttribute("id",n);r.style.display="none";document.body.appendChild(r);r.contentWindow.document.open();r.contentWindow.document.close();i="";s=false;e.checkerFunction=function(){if(s){return false}s=true;var n=e.getHash()||"",o=e.unescapeHash(r.contentWindow.document.location.hash)||"";if(n!==t){t=n;if(o!==n){i=o=n;r.contentWindow.document.open();r.contentWindow.document.close();r.contentWindow.document.location.hash=e.escapeHash(n)}e.Adapter.trigger(window,"hashchange")}else if(o!==i){i=o;e.setHash(o,false)}s=false;return true}}else{e.checkerFunction=function(){var n=e.getHash();if(n!==t){t=n;e.Adapter.trigger(window,"hashchange")}return true}}e.intervalList.push(setInterval(e.checkerFunction,e.options.hashChangeInterval));return true};e.Adapter.onDomLoad(e.hashChangeInit)}if(e.emulated.pushState){e.onHashChange=function(t){var n=t&&t.newURL||document.location.href,r=e.getHashByUrl(n),i=null,s=null,o=null,u;if(e.isLastHash(r)){e.busy(false);return false}e.doubleCheckComplete();e.saveHash(r);if(r&&e.isTraditionalAnchor(r)){e.Adapter.trigger(window,"anchorchange");e.busy(false);return false}i=e.extractState(e.getFullUrl(r||document.location.href,false),true);if(e.isLastSavedState(i)){e.busy(false);return false}s=e.getHashByState(i);u=e.discardedState(i);if(u){if(e.getHashByIndex(-2)===e.getHashByState(u.forwardState)){e.back(false)}else{e.forward(false)}return false}e.pushState(i.data,i.title,i.url,false);return true};e.Adapter.bind(window,"hashchange",e.onHashChange);e.pushState=function(t,n,r,i){if(e.getHashByUrl(r)){throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).")}if(i!==false&&e.busy()){e.pushQueue({scope:e,callback:e.pushState,args:arguments,queue:i});return false}e.busy(true);var s=e.createStateObject(t,n,r),o=e.getHashByState(s),u=e.getState(false),a=e.getHashByState(u),f=e.getHash();e.storeState(s);e.expectedStateId=s.id;e.recycleState(s);e.setTitle(s);if(o===a){e.busy(false);return false}if(o!==f&&o!==e.getShortUrl(document.location.href)){e.setHash(o,false);return false}e.saveState(s);e.Adapter.trigger(window,"statechange");e.busy(false);return true};e.replaceState=function(t,n,r,i){if(e.getHashByUrl(r)){throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).")}if(i!==false&&e.busy()){e.pushQueue({scope:e,callback:e.replaceState,args:arguments,queue:i});return false}e.busy(true);var s=e.createStateObject(t,n,r),o=e.getState(false),u=e.getStateByIndex(-2);e.discardState(o,s,u);e.pushState(s.data,s.title,s.url,false);return true}}if(e.emulated.pushState){if(e.getHash()&&!e.emulated.hashChange){e.Adapter.onDomLoad(function(){e.Adapter.trigger(window,"hashchange")})}}};var n=window.console||undefined,r=window.sessionStorage||false,i=Ext.JSON,s=window.history;i.stringify=i.encode;i.parse=i.decode;e.init=function(){if(e.initialized){return false}e.initCore();e.initHtml4();e.initialized=true;return true};e.initCore=function(){e.options=e.options||{};e.options.hashChangeInterval=e.options.hashChangeInterval||100;e.options.safariPollInterval=e.options.safariPollInterval||500;e.options.doubleCheckInterval=e.options.doubleCheckInterval||500;e.options.storeInterval=e.options.storeInterval||1e3;e.options.busyDelay=e.options.busyDelay||250;e.options.debug=e.options.debug||false;e.options.initialTitle=e.options.initialTitle||document.title;e.intervalList=[];e.clearAllIntervals=function(){var t,n=e.intervalList;if(typeof n!=="undefined"&&n!==null){for(t=0;t<n.length;t++){clearInterval(n[t])}e.intervalList=null}};e.debug=function(){if(e.options.debug||false){e.log.apply(e,arguments)}};e.log=function(){var e=!(typeof n==="undefined"||typeof n.log==="undefined"||typeof n.log.apply==="undefined"),t=document.getElementById("log"),r,s,o,u,a;if(e){u=Array.prototype.slice.call(arguments);r=u.shift();if(typeof n.debug!=="undefined"){n.debug.apply(n,[r,u])}else{n.log.apply(n,[r,u])}}else{r="\n"+arguments[0]+"\n"}for(s=1,o=arguments.length;s<o;++s){a=arguments[s];if(typeof a==="object"&&typeof i!=="undefined"){try{a=i.stringify(a)}catch(f){}}r+="\n"+a+"\n"}if(t){t.value+=r+"\n-----\n";t.scrollTop=t.scrollHeight-t.clientHeight}else if(!e){alert(r)}return true};e.getInternetExplorerMajorVersion=function(){var t=e.getInternetExplorerMajorVersion.cached=typeof e.getInternetExplorerMajorVersion.cached!=="undefined"?e.getInternetExplorerMajorVersion.cached:function(){var e=3,t=document.createElement("div"),n=t.getElementsByTagName("i");while((t.innerHTML="<!--[if gt IE "+ ++e+"]><i></i><![endif]-->")&&n[0]){}return e>4?e:false}();return t};e.isInternetExplorer=function(){var t=e.isInternetExplorer.cached=typeof e.isInternetExplorer.cached!=="undefined"?e.isInternetExplorer.cached:Boolean(e.getInternetExplorerMajorVersion());return t};e.emulated={pushState:!Boolean(window.history&&window.history.pushState&&window.history.replaceState&&!(/ Mobile\/([1-7][a-z]|(8([abcde]|f(1[0-8]))))/i.test(navigator.userAgent)||/AppleWebKit\/5([0-2]|3[0-2])/i.test(navigator.userAgent))),hashChange:Boolean(!("onhashchange"in window||"onhashchange"in document)||e.isInternetExplorer()&&e.getInternetExplorerMajorVersion()<8)};e.enabled=!e.emulated.pushState;e.bugs={setHash:Boolean(!e.emulated.pushState&&navigator.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(navigator.userAgent)),safariPoll:Boolean(!e.emulated.pushState&&navigator.vendor==="Apple Computer, Inc."&&/AppleWebKit\/5([0-2]|3[0-3])/.test(navigator.userAgent)),ieDoubleCheck:Boolean(e.isInternetExplorer()&&e.getInternetExplorerMajorVersion()<8),hashEscape:Boolean(e.isInternetExplorer()&&e.getInternetExplorerMajorVersion()<7)};e.isEmptyObject=function(e){for(var t in e){return false}return true};e.cloneObject=function(e){var t,n;if(e){t=i.stringify(e);n=i.parse(t)}else{n={}}return n};e.getRootUrl=function(){var e=document.location.protocol+"//"+(document.location.hostname||document.location.host);if(document.location.port||false){e+=":"+document.location.port}e+="/";return e};e.getBaseHref=function(){var e=document.getElementsByTagName("base"),t=null,n="";if(e.length===1){t=e[0];n=t.href.replace(/[^\/]+$/,"")}n=n.replace(/\/+$/,"");if(n)n+="/";return n};e.getBaseUrl=function(){var t=e.getBaseHref()||e.getBasePageUrl()||e.getRootUrl();return t};e.getPageUrl=function(){var t=e.getState(false,false),n=(t||{}).url||document.location.href,r;r=n.replace(/\/+$/,"").replace(/[^\/]+$/,function(e,t,n){return/\./.test(e)?e:e+"/"});return r};e.getBasePageUrl=function(){var e=document.location.href.replace(/[#\?].*/,"").replace(/[^\/]+$/,function(e,t,n){return/[^\/]$/.test(e)?"":e}).replace(/\/+$/,"")+"/";return e};e.getFullUrl=function(t,n){var r=t,i=t.substring(0,1);n=typeof n==="undefined"?true:n;if(/[a-z]+\:\/\//.test(t)){}else if(i==="/"){r=e.getRootUrl()+t.replace(/^\/+/,"")}else if(i==="#"){r=e.getPageUrl().replace(/#.*/,"")+t}else if(i==="?"){r=e.getPageUrl().replace(/[\?#].*/,"")+t}else{if(n){r=e.getBaseUrl()+t.replace(/^(\.\/)+/,"")}else{r=e.getBasePageUrl()+t.replace(/^(\.\/)+/,"")}}return r.replace(/\#$/,"")};e.getShortUrl=function(t){var n=t,r=e.getBaseUrl(),i=e.getRootUrl();if(e.emulated.pushState){n=n.replace(r,"")}n=n.replace(i,"/");if(e.isTraditionalAnchor(n)){n="./"+n}n=n.replace(/^(\.\/)+/g,"./").replace(/\#$/,"");return n};e.store={};e.idToState=e.idToState||{};e.stateToId=e.stateToId||{};e.urlToId=e.urlToId||{};e.storedStates=e.storedStates||[];e.savedStates=e.savedStates||[];e.normalizeStore=function(){e.store.idToState=e.store.idToState||{};e.store.urlToId=e.store.urlToId||{};e.store.stateToId=e.store.stateToId||{}};e.getState=function(t,n){if(typeof t==="undefined"){t=true}if(typeof n==="undefined"){n=true}var r=e.getLastSavedState();if(!r&&n){r=e.createStateObject()}if(t){r=e.cloneObject(r);r.url=r.cleanUrl||r.url}return r};e.getIdByState=function(t){var n=e.extractId(t.url),r;if(!n){r=e.getStateString(t);if(typeof e.stateToId[r]!=="undefined"){n=e.stateToId[r]}else if(typeof e.store.stateToId[r]!=="undefined"){n=e.store.stateToId[r]}else{while(true){n=(new Date).getTime()+String(Math.random()).replace(/\D/g,"");if(typeof e.idToState[n]==="undefined"&&typeof e.store.idToState[n]==="undefined"){break}}e.stateToId[r]=n;e.idToState[n]=t}}return n};e.normalizeState=function(t){var n,r;if(!t||typeof t!=="object"){t={}}if(typeof t.normalized!=="undefined"){return t}if(!t.data||typeof t.data!=="object"){t.data={}}n={};n.normalized=true;n.title=t.title||"";n.url=e.getFullUrl(e.unescapeString(t.url||document.location.href));n.hash=e.getShortUrl(n.url);n.data=e.cloneObject(t.data);n.id=e.getIdByState(n);n.cleanUrl=n.url.replace(/\??\&_suid.*/,"");n.url=n.cleanUrl;r=!e.isEmptyObject(n.data);if(n.title||r){n.hash=e.getShortUrl(n.url).replace(/\??\&_suid.*/,"");if(!/\?/.test(n.hash)){n.hash+="?"}n.hash+="&_suid="+n.id}n.hashedUrl=e.getFullUrl(n.hash);if((e.emulated.pushState||e.bugs.safariPoll)&&e.hasUrlDuplicate(n)){n.url=n.hashedUrl}return n};e.createStateObject=function(t,n,r){var i={data:t,title:n,url:r};i=e.normalizeState(i);return i};e.getStateById=function(t){t=String(t);var n=e.idToState[t]||e.store.idToState[t]||undefined;return n};e.getStateString=function(t){var n,r,s;n=e.normalizeState(t);r={data:n.data,title:t.title,url:t.url};s=i.stringify(r);return s};e.getStateId=function(t){var n,r;n=e.normalizeState(t);r=n.id;return r};e.getHashByState=function(t){var n,r;n=e.normalizeState(t);r=n.hash;return r};e.extractId=function(e){var t,n,r;n=/(.*)\&_suid=([0-9]+)$/.exec(e);r=n?n[1]||e:e;t=n?String(n[2]||""):"";return t||false};e.isTraditionalAnchor=function(e){var t=!/[\/\?\.]/.test(e);return t};e.extractState=function(t,n){var r=null,i,s;n=n||false;i=e.extractId(t);if(i){r=e.getStateById(i)}if(!r){s=e.getFullUrl(t);i=e.getIdByUrl(s)||false;if(i){r=e.getStateById(i)}if(!r&&n&&!e.isTraditionalAnchor(t)){r=e.createStateObject(null,null,s)}}return r};e.getIdByUrl=function(t){var n=e.urlToId[t]||e.store.urlToId[t]||undefined;return n};e.getLastSavedState=function(){return e.savedStates[e.savedStates.length-1]||undefined};e.getLastStoredState=function(){return e.storedStates[e.storedStates.length-1]||undefined};e.hasUrlDuplicate=function(t){var n=false,r;r=e.extractState(t.url);n=r&&r.id!==t.id;return n};e.storeState=function(t){e.urlToId[t.url]=t.id;e.storedStates.push(e.cloneObject(t));return t};e.isLastSavedState=function(t){var n=false,r,i,s;if(e.savedStates.length){r=t.id;i=e.getLastSavedState();s=i.id;n=r===s}return n};e.saveState=function(t){if(e.isLastSavedState(t)){return false}e.savedStates.push(e.cloneObject(t));return true};e.getStateByIndex=function(t){var n=null;if(typeof t==="undefined"){n=e.savedStates[e.savedStates.length-1]}else if(t<0){n=e.savedStates[e.savedStates.length+t]}else{n=e.savedStates[t]}return n};e.getHash=function(){var t=e.unescapeHash(document.location.hash);return t};e.unescapeString=function(e){var t=e,n;while(true){n=window.unescape(t);if(n===t){break}t=n}return t};e.unescapeHash=function(t){var n=e.normalizeHash(t);n=e.unescapeString(n);return n};e.normalizeHash=function(e){var t=e.replace(/[^#]*#/,"").replace(/#.*/,"");return t};e.setHash=function(t,n){var r,i,s;if(n!==false&&e.busy()){e.pushQueue({scope:e,callback:e.setHash,args:arguments,queue:n});return false}r=e.escapeHash(t);e.busy(true);i=e.extractState(t,true);if(i&&!e.emulated.pushState){e.pushState(i.data,i.title,i.url,false)}else if(document.location.hash!==r){if(e.bugs.setHash){s=e.getPageUrl();e.pushState(null,null,s+"#"+r,false)}else{document.location.hash=r}}return e};e.escapeHash=function(t){var n=e.normalizeHash(t);n=window.escape(n);if(!e.bugs.hashEscape){n=n.replace(/\%21/g,"!").replace(/\%26/g,"&").replace(/\%3D/g,"=").replace(/\%3F/g,"?")}return n};e.getHashByUrl=function(t){var n=String(t).replace(/([^#]*)#?([^#]*)#?(.*)/,"$2");n=e.unescapeHash(n);return n};e.setTitle=function(t){var n=t.title,r;if(!n){r=e.getStateByIndex(0);if(r&&r.url===t.url){n=r.title||e.options.initialTitle}}try{document.getElementsByTagName("title")[0].innerHTML=n.replace("<","<").replace(">",">").replace(" & "," & ")}catch(i){}document.title=n;return e};e.queues=[];e.busy=function(t){if(typeof t!=="undefined"){e.busy.flag=t}else if(typeof e.busy.flag==="undefined"){e.busy.flag=false}if(!e.busy.flag){clearTimeout(e.busy.timeout);var n=function(){var t,r,i;if(e.busy.flag)return;for(t=e.queues.length-1;t>=0;--t){r=e.queues[t];if(r.length===0)continue;i=r.shift();e.fireQueueItem(i);e.busy.timeout=setTimeout(n,e.options.busyDelay)}};e.busy.timeout=setTimeout(n,e.options.busyDelay)}return e.busy.flag};e.busy.flag=false;e.fireQueueItem=function(t){return t.callback.apply(t.scope||e,t.args||[])};e.pushQueue=function(t){e.queues[t.queue||0]=e.queues[t.queue||0]||[];e.queues[t.queue||0].push(t);return e};e.queue=function(t,n){if(typeof t==="function"){t={callback:t}}if(typeof n!=="undefined"){t.queue=n}if(e.busy()){e.pushQueue(t)}else{e.fireQueueItem(t)}return e};e.clearQueue=function(){e.busy.flag=false;e.queues=[];return e};e.stateChanged=false;e.doubleChecker=false;e.doubleCheckComplete=function(){e.stateChanged=true;e.doubleCheckClear();return e};e.doubleCheckClear=function(){if(e.doubleChecker){clearTimeout(e.doubleChecker);e.doubleChecker=false}return e};e.doubleCheck=function(t){e.stateChanged=false;e.doubleCheckClear();if(e.bugs.ieDoubleCheck){e.doubleChecker=setTimeout(function(){e.doubleCheckClear();if(!e.stateChanged){t()}return true},e.options.doubleCheckInterval)}return e};e.safariStatePoll=function(){var t=e.extractState(document.location.href),n;if(!e.isLastSavedState(t)){n=t}else{return}if(!n){n=e.createStateObject()}e.Adapter.trigger(window,"popstate");return e};e.back=function(t){if(t!==false&&e.busy()){e.pushQueue({scope:e,callback:e.back,args:arguments,queue:t});return false}e.busy(true);e.doubleCheck(function(){e.back(false)});s.go(-1);return true};e.forward=function(t){if(t!==false&&e.busy()){e.pushQueue({scope:e,callback:e.forward,args:arguments,queue:t});return false}e.busy(true);e.doubleCheck(function(){e.forward(false)});s.go(1);return true};e.go=function(t,n){var r;if(t>0){for(r=1;r<=t;++r){e.forward(n)}}else if(t<0){for(r=-1;r>=t;--r){e.back(n)}}else{throw new Error("History.go: History.go requires a positive or negative integer passed.")}return e};if(e.emulated.pushState){var t=function(){};e.pushState=e.pushState||t;e.replaceState=e.replaceState||t}else{e.onPopState=function(t,n){var r=false,i=false,s,o;e.doubleCheckComplete();s=e.getHash();if(s){o=e.extractState(s||document.location.href,true);if(o){e.replaceState(o.data,o.title,o.url,false)}else{e.Adapter.trigger(window,"anchorchange");e.busy(false)}e.expectedStateId=false;return false}r=e.Adapter.extractEventData("state",t,n)||false;if(r){i=e.getStateById(r)}else if(e.expectedStateId){i=e.getStateById(e.expectedStateId)}else{i=e.extractState(document.location.href)}if(!i){i=e.createStateObject(null,null,document.location.href)}e.expectedStateId=false;if(e.isLastSavedState(i)){e.busy(false);return false}e.storeState(i);e.saveState(i);e.setTitle(i);e.Adapter.trigger(window,"statechange");e.busy(false);return true};e.Adapter.bind(window,"popstate",e.onPopState);e.pushState=function(t,n,r,i){if(e.getHashByUrl(r)&&e.emulated.pushState){throw new Error("History.js does not support states with fragment-identifiers (hashes/anchors).")}if(i!==false&&e.busy()){e.pushQueue({scope:e,callback:e.pushState,args:arguments,queue:i});return false}e.busy(true);var o=e.createStateObject(t,n,r);if(e.isLastSavedState(o)){e.busy(false)}else{e.storeState(o);e.expectedStateId=o.id;s.pushState(o.id,o.title,o.url);e.Adapter.trigger(window,"popstate")}return true};e.replaceState=function(t,n,r,i){if(e.getHashByUrl(r)&&e.emulated.pushState){throw new Error("History.js does not support states with fragement-identifiers (hashes/anchors).")}if(i!==false&&e.busy()){e.pushQueue({scope:e,callback:e.replaceState,args:arguments,queue:i});return false}e.busy(true);var o=e.createStateObject(t,n,r);if(e.isLastSavedState(o)){e.busy(false)}else{e.storeState(o);e.expectedStateId=o.id;s.replaceState(o.id,o.title,o.url);e.Adapter.trigger(window,"popstate")}return true}}if(r){try{e.store=i.parse(r.getItem("History.store"))||{}}catch(o){e.store={}}e.normalizeStore()}else{e.store={};e.normalizeStore()}e.Adapter.bind(window,"beforeunload",e.clearAllIntervals);e.Adapter.bind(window,"unload",e.clearAllIntervals);e.saveState(e.storeState(e.extractState(document.location.href,true)));if(r){e.onUnload=function(){var t,n;try{t=i.parse(r.getItem("History.store"))||{}}catch(s){t={}}t.idToState=t.idToState||{};t.urlToId=t.urlToId||{};t.stateToId=t.stateToId||{};for(n in e.idToState){if(!e.idToState.hasOwnProperty(n)){continue}t.idToState[n]=e.idToState[n]}for(n in e.urlToId){if(!e.urlToId.hasOwnProperty(n)){continue}t.urlToId[n]=e.urlToId[n]}for(n in e.stateToId){if(!e.stateToId.hasOwnProperty(n)){continue}t.stateToId[n]=e.stateToId[n]}e.store=t;e.normalizeStore();r.setItem("History.store",i.stringify(t))};e.intervalList.push(setInterval(e.onUnload,e.options.storeInterval));e.Adapter.bind(window,"beforeunload",e.onUnload);e.Adapter.bind(window,"unload",e.onUnload)}if(!e.emulated.pushState){if(e.bugs.safariPoll){e.intervalList.push(setInterval(e.safariStatePoll,e.options.safariPollInterval))}if(navigator.vendor==="Apple Computer, Inc."||(navigator.appCodeName||"")==="Mozilla"){e.Adapter.bind(window,"hashchange",function(){e.Adapter.trigger(window,"popstate")});if(e.getHash()){e.Adapter.onDomLoad(function(){e.Adapter.trigger(window,"hashchange")})}}}};return{singleton:true,extend:"Ext.util.Observable",requires:["Ext.JSON"],pushState:function(t,n,r){e.pushState(t,n,r)},replaceState:function(t,n,r){e.replaceState(t,n,r)},getState:function(){return e.getState()},back:function(){e.back()},forward:function(){e.forward()},go:function(t){e.go(t)},init:function(){e.init()}}});